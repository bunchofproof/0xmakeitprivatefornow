// Prisma schema for Discord Admin Verification System with ZKPassport
// This schema extends the existing Discord bot OAuth foundation with zero-knowledge verification capabilities

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// Existing Discord OAuth user model - maintains compatibility with existing bot functionality
model User {
  id           String @id @default(uuid())
  userId       String @unique
  accessToken  String @unique
  refreshToken String @unique

  @@map("users")
}

// ============================================================================
// ZKPassport Admin Verification System Models
// ============================================================================

// Core model storing verified admin users with their ZKPassport anonymous identifiers
// SECURITY: Only stores anonymous identifiers, never personal information
model AdminVerification {
  id                   String   @id @default(cuid())
  discordUserId        String   @unique // Discord user ID for lookup and management
  passportFingerprint  String   @unique // ZKPassport fingerprint for verification matching
  uniqueIdentifier     String   @unique // ZKPassport anonymous identifier only - no personal data
  lastVerified         DateTime @updatedAt // Automatically updated on verification changes
  createdAt            DateTime @default(now())
  isActive             Boolean  @default(true) // Allows for admin deactivation without deletion
  expiryDate           DateTime? // Optional expiry for periodic re-verification requirements

  // The Heartbeat (Continuous Verification) and trust scoring
  reverificationIntervalDays Int?     @default(90) // Nullable for existing records
  trustScore                 Int      @default(100)
  
  // Relationships
  history          VerificationHistory[]
  actions          AdminActionLog[]

  // Performance indexes
  @@index([discordUserId])
  @@index([uniqueIdentifier])
  @@index([isActive, expiryDate])
  @@map("admin_verifications")
}

// Temporary sessions for ZKPassport verification process
// Provides secure token-based verification flow with automatic cleanup
model VerificationSession {
  id            String   @id @default(cuid())
  token         String   @unique // Secure random token for verification process
  discordUserId String   // Links to Discord user initiating verification
  expiresAt     DateTime // Automatic expiry for security
  lastUsedAt    DateTime? // Optional timestamp for last usage tracking
  usageCount    Int      @default(0) // Tracks how many times the session has been used
  invalidationAttempts Int @default(0) // Tracks failed attempts to invalidate the session
  used          Boolean  @default(false) // Prevents token reuse
  createdAt     DateTime @default(now())
  bindingHash     String
  lastContextHash String

  // Relationships
  // NOTE: Removed foreign key constraint to allow sessions for unverified users

  // Performance indexes
  @@index([token])
  @@index([discordUserId])
  @@index([expiresAt])
  @@index([used, expiresAt])
  @@map("verification_sessions")
}

// Comprehensive history tracking for all verification attempts
// Enables security monitoring, debugging, and audit trails
model VerificationHistory {
    id            String   @id @default(cuid())
    discordUserId String?  // Discord user ID for correlation across attempts - made optional
    success       Boolean  // Whether the verification attempt succeeded
    timestamp     DateTime @default(now())
    errorMessage  String?  // Optional error details for failed attempts

    // Relationships
    adminVerification AdminVerification? @relation(fields: [discordUserId], references: [discordUserId], onDelete: Cascade)

    // Performance indexes
    @@index([discordUserId])
    @@index([success, timestamp])
    @@index([timestamp])
    @@map("verification_history")
}

model AdminActionLog {
  id          String   @id @default(cuid())
  actionType  String   // e.g., "BAN_USER", "KICK_USER", "DELETE_CHANNEL"
  targetId    String   // The ID of the user/channel affected
  reason      String?
  metadata    Json?    // For extra data like IP address, etc.
  timestamp   DateTime @default(now())

  // Relation to the admin who performed the action
  admin       AdminVerification @relation(fields: [adminId], references: [id], onDelete: Cascade)
  adminId     String
}

// ============================================================================
// Security and Audit Models
// ============================================================================

// Automated Response configuration
model ServerConfig {
  guildId             String  @id // The Discord Server ID is the primary key
  lockdownThreshold   Int     @default(50)
  alertChannelId      String?
}

// Comprehensive audit logging for security monitoring and compliance
model AuditLog {
  id            String   @id @default(cuid())
  action        String   // Action performed (e.g., "login", "verification_attempt")
  userId        String?  // Discord user ID if applicable
  resource      String?  // Resource affected (e.g., "verification_session")
  resourceId    String?  // ID of the affected resource
  details       Json?    // Additional context/details in JSON format
  ipAddress     String?  // IP address for security tracking
  userAgent     String?  // User agent string
  success       Boolean  // Whether the action succeeded
  timestamp     DateTime @default(now())
  severity      String   // "info", "warning", "error", "critical"

  // Performance indexes
  @@index([action])
  @@index([userId])
  @@index([timestamp])
  @@index([severity, timestamp])
  @@map("audit_logs")
}